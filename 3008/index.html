<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fireworks High Sky</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let W = window.innerWidth, H = window.innerHeight;
canvas.width = W; canvas.height = H;
const DPR = window.devicePixelRatio || 1;

window.addEventListener("resize", ()=>{
  W = window.innerWidth; H = window.innerHeight;
  canvas.width = W; canvas.height = H;
});

const fw = { rockets:[], sparks:[], lastLaunch:0, launchInterval:650 };

// phóng rocket
function launchRocket(){
  const x = Math.random()*W*0.8 + W*0.1;
  const y = H + 8*DPR;
  const vx = (Math.random()-0.5)*1.8*DPR;      // bay ngang mạnh hơn
  const vy = -(4 + Math.random()*3.5)*DPR;     // bay lên nhanh hơn

  // chọn độ cao nổ (y nhỏ là cao)
  let targetY;
  const r = Math.random();
  if (r < 0.25) {
    targetY = H * (0.03 + Math.random()*0.09); // 25%: SIÊU CAO (2%–7%)
  } else if (r < 0.60) {
    targetY = H * (0.07 + Math.random()*0.13); // 35%: cao (7%–20%)
  } else {
    targetY = H * (0.20 + Math.random()*0.55); // 40%: trung bình (20%–75%)
  }

  const colors = [
    "hsl(0,100%,70%)","hsl(50,100%,70%)","hsl(120,100%,70%)",
    "hsl(200,100%,70%)","hsl(280,100%,70%)"
  ];
  const color = colors[(Math.random()*colors.length)|0];

  fw.rockets.push({x,y,vx,vy,color,targetY});
}

// nổ pháo hoa
function explode(x,y,color){
  const type = (Math.random()*4)|0; // 0: tròn,1:ring,2:heart
  const count = 150;
  for (let i=0;i<count;i++){
    let angle, speed, vx, vy;
    if (type===0){ // tròn
      angle = Math.random()*Math.PI*2;
      speed = (Math.random()*3 + 1) * DPR;
      vx = Math.cos(angle)*speed; vy = Math.sin(angle)*speed;
    } else if (type===1){ // ring
      angle = (i/count)*Math.PI*2;
      speed = 3 * DPR;
      vx = Math.cos(angle)*speed*(0.8+Math.random()*0.4);
      vy = Math.sin(angle)*speed*(0.8+Math.random()*0.4);
    } else { // heart
      const t = Math.random()*Math.PI*2;
      const hx = 16*Math.pow(Math.sin(t),3);
      const hy = -(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
      vx = hx * 0.2 * DPR + (Math.random()-0.5);
      vy = hy * 0.2 * DPR + (Math.random()-0.5);
    }
    fw.sparks.push({
      x,y,vx,vy,life:0,
      maxLife:70 + (Math.random()*40|0),
      color,size: Math.random()*1.6 + 0.8
    });
  }
}

function animate(){
  requestAnimationFrame(animate);
  ctx.fillStyle="rgba(0,0,0,0.2)";
  ctx.fillRect(0,0,W,H);

  const now = performance.now();
  if (now - fw.lastLaunch > fw.launchInterval){
    fw.lastLaunch = now;
    if (fw.rockets.length < 7) launchRocket();
  }

  // update rockets (không còn TTL; nổ theo targetY)
  for (let i=fw.rockets.length-1;i>=0;i--){
    const r = fw.rockets[i];
    r.x += r.vx; r.y += r.vy;
    r.vy += 0.008*DPR; // trọng lực nhẹ hơn để bay cao hơn

    // vẽ rocket + đuôi sáng
    ctx.beginPath();
    ctx.arc(r.x, r.y, 2.6*DPR, 0, Math.PI*2);
    ctx.fillStyle = '#fff'; ctx.fill();
    for (let j=0;j<3;j++){
      ctx.beginPath();
      ctx.arc(r.x-(r.vx*j*3), r.y-(r.vy*j*3), (2.6-j*0.7)*DPR, 0, Math.PI*2);
      ctx.fillStyle = `rgba(255,255,200,${0.3 - j*0.08})`;
      ctx.fill();
    }

    // nổ: khi chạm target hoặc gần đỉnh, hoặc lỡ bay ra khỏi màn
    if (r.y <= r.targetY || r.y <= 8*DPR || r.y > H+50*DPR){
      explode(r.x, r.y, r.color);
      fw.rockets.splice(i,1);
    }
  }

  // update sparks
  ctx.globalCompositeOperation = "lighter";
  for (let i=fw.sparks.length-1;i>=0;i--){
    const s = fw.sparks[i];
    s.life++; s.x += s.vx; s.y += s.vy;
    s.vy += 0.015*DPR; s.vx *= 0.995; s.vy *= 0.995;
    const alpha = Math.max(0, 1 - s.life/s.maxLife);

    // halo ngoài
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size*2.2*DPR, 0, Math.PI*2);
    ctx.fillStyle = `rgba(255,255,255,${alpha*0.15})`; ctx.fill();

    // sáng trong
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size*DPR, 0, Math.PI*2);
    ctx.fillStyle = `rgba(255,255,255,${alpha*0.6})`; ctx.fill();

    // lõi màu
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size*0.9*DPR, 0, Math.PI*2);
    ctx.fillStyle = s.color.replace('70%)', (60+alpha*40)+'%)'); ctx.fill();

    if (s.life >= s.maxLife) fw.sparks.splice(i,1);
  }
  ctx.globalCompositeOperation = "source-over";
}
animate();
</script>
</body>
</html>